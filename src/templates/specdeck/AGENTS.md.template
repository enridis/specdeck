<!-- SPECDECK:START -->
# SpecDeck Tool Instructions

**Purpose:** SpecDeck is a CLI tool for managing engineering stories through Git-based Markdown files. Supports standalone and coordinator (multi-repo) modes with feature-based file structure.

---

## Project Modes

### Standalone Mode
Single repository with `specdeck/` directory for stories.

### Coordinator Mode (Multi-Repo)
Coordinator project aggregates stories from multiple submodule repositories.

**Check mode:** Look for `"coordinator": {"enabled": true}` in `.specdeck.config.json`

---

## Quick Commands Reference

### Standalone Mode
```bash
specdeck list stories               # List all stories
specdeck list stories --feature CLI-CORE # Filter by feature
specdeck list features --with-stories    # Show features with stories
specdeck validate all              # Validate all SpecDeck files
```

### Coordinator Mode
```bash
specdeck sync                      # Aggregate stories from all submodules (run after submodule updates)
specdeck list stories              # View aggregated stories (uses cache)
specdeck list stories --repo backend  # Filter by submodule
```

---

## File Structure

### Standalone Mode
```
.specdeck.config.json              # Configuration file
specdeck/
  releases/
    R1-foundation.md               # Release overview + feature list
    R1-foundation/                 # Feature-specific story files
      CLI-CORE.md                  # Stories for CLI-CORE feature
      REL-01.md                    # Stories for REL-01 feature
```

### Coordinator Mode
```
.specdeck.config.json              # Config with coordinator.enabled=true
.specdeck-cache/                   # Cached aggregated stories
  stories.json                     # Aggregated from all submodules
overlays/                          # Jira mappings per submodule (optional)
  backend/
    CLI-CORE.md                    # Jira ticket mappings
submodule-repos/                   # Git submodules (managed by git)
  backend/                         # Each has own specdeck/ directory
    specdeck/releases/...
  frontend/
    specdeck/releases/...
```

**Key Differences:**
- **Standalone:** Stories are local in `specdeck/releases/`
- **Coordinator:** Stories aggregated from submodules into `.specdeck-cache/stories.json`
- **Coordinator requires sync:** Run `specdeck sync` to refresh cache after submodule changes

---

## Coordinator Mode Workflows

### When Working in Coordinator Project

**Check if sync needed:**
```bash
specdeck list stories  # Uses cached data
# If cache is stale, you'll see a warning
```

**After submodule updates (user updates via git):**
```bash
specdeck sync  # Refresh aggregated cache
```

**View aggregated stories:**
```bash
specdeck list stories              # All stories from all submodules
specdeck list stories --repo backend  # Filter by specific submodule
specdeck list stories --status in_progress  # Filter by status
```

### When Working in Submodule Project

**You're in a submodule if:**
- Directory is nested under coordinator (e.g., `backend/`)
- Has own `specdeck/` directory
- May or may not have `.specdeck.config.json`

**Update stories normally:**
1. Edit story in feature file: `specdeck/releases/R1-foundation/CLI-CORE.md`
2. Change status in markdown table: `planned` → `in_progress`
3. Validate: `specdeck validate all`
4. Leave for user to commit

**Note:** User must commit in submodule, update coordinator reference, and run `specdeck sync`

---

## ⚠️ CRITICAL: Single Story Table Rule

**Each feature file MUST contain EXACTLY ONE story table.**

❌ **WRONG - Multiple Tables:**
```markdown
## Sprint 1 Stories
| ID | Title | Status |
|----|-------|--------|
| CLI-CORE-01 | Setup | done |

## Sprint 2 Stories  
| ID | Title | Status |
|----|-------|--------|
| CLI-CORE-02 | Logging | in_progress |
```

✅ **CORRECT - Single Table:**
```markdown
## Stories

| ID | Title | Status | Complexity | Estimate | Owner | Tags | Notes |
|----|-------|--------|------------|----------|-------|------|-------|
| CLI-CORE-01 | Setup | done | M | 5 | @user | cli | Commander.js |
| CLI-CORE-02 | Logging | in_progress | S | 3 | @user | cli | Error handling |
```

**Why Single Table:**
- Parser reads FIRST table only - subsequent tables are silently ignored
- Creates data loss if multiple tables used
- Maintains consistency across all feature files
- Simplifies querying and filtering

**If too many stories:**
- Split into multiple feature files (CLI-CORE-AUTH.md, CLI-CORE-CONFIG.md)
- Keep <10 stories per feature (recommended)

---

## Release Overview File Format

**File:** `specdeck/releases/R1-foundation.md`

```markdown
---
id: R1-foundation
title: Foundation Release
timeframe: Q1 2025
---

# Release: R1 - Foundation

## Objectives
- Establish core CLI framework
- Enable teams to navigate planning hierarchy

## Features

- **CLI-CORE**: CLI Entry Point and Command Framework
  - Hierarchical command structure with Commander.js
  - Global options (--version, --help, --json)

- **REL-01**: Release Management
  - List all releases with summary information

## Feature Files

- [CLI-CORE](./R1-foundation/CLI-CORE.md) - 4 stories
- [REL-01](./R1-foundation/REL-01.md) - 6 stories
```

**Required YAML Front Matter:**
- `id` - Release identifier (matches directory name)
- `title` - Human-readable release name
- `timeframe` - Quarter or date range

---

## Feature Story File Format

**File:** `specdeck/releases/R1-foundation/CLI-CORE.md`

```markdown
---
feature: CLI-CORE
release: R1-foundation
jira_epic: PROJ-123
---

# Feature: CLI-CORE

## Description

CLI Entry Point and Command Framework

## Stories

| ID | Title | Status | Complexity | Estimate | Owner | Tags | Notes |
|----|-------|--------|------------|----------|-------|------|-------|
| CLI-CORE-01 | CLI entry point | done | M | 5 | @user | cli, infra | Commander.js |
| CLI-CORE-02 | Error handling | in_progress | S | 3 | @user | cli | Catch errors |
| CLI-CORE-03 | Output formatting | planned | S | 3 | @user | cli | JSON/table |
```

**Required YAML Front Matter:**
- `feature` - Feature ID (must match filename: CLI-CORE.md)
- `release` - Release ID (must match parent directory: R1-foundation)

**Optional YAML Front Matter:**
- `jira_epic` - Jira Epic key (e.g., `PROJ-123`)

---

## Story Table Columns

**Required Columns:**
| Column | Format | Description | Valid Values |
|--------|--------|-------------|--------------|
| ID | FEATURE-NUMBER | Story identifier | CLI-CORE-01, REL-01-05 |
| Title | Text (3-12 words) | Brief description | - |
| Status | Enum | Current state | `planned`, `in_progress`, `in_review`, `blocked`, `done` |
| Complexity | Enum | Estimated effort | `XS`, `S`, `M`, `L`, `XL` |

**Optional Columns:**
| Column | Format | Description |
|--------|--------|-------------|
| Estimate | Number | Story points or hours |
| Owner | Text | @username or team name |
| Jira | Text | Jira ticket reference |
| Tags | Text | Comma-separated labels (e.g., "cli, infra") |
| Notes | Text | Additional context |

**Column Order:**
- Required columns first: ID, Title, Status, Complexity
- Optional columns after: Estimate, Owner, Tags, Notes
- Maintain consistent order across all feature files

---

## Story ID Format

**Pattern:** `FEATURE-NUMBER`
- `FEATURE` - Feature identifier (2-8 uppercase letters/numbers with hyphens)
- `NUMBER` - 2-digit story number (01-99)

**Examples:**
- `CLI-CORE-01` - CLI Core feature, story 01
- `REL-01-05` - Release Management feature 01, story 05

**Rules:**
- Story ID MUST match feature file (CLI-CORE-01 belongs in CLI-CORE.md)
- IDs must be unique within feature
- Use sequential numbers (01, 02, 03, ...)

---

## Story Status Values

| Status | Meaning | When to Use |
|--------|---------|-------------|
| `planned` | Not started, in backlog | Story defined but no work begun |
| `in_progress` | Actively being worked on | Developer has started implementation |
| `in_review` | Code complete, under review | PR open, awaiting approval |
| `blocked` | Waiting on dependency | Cannot proceed due to external factor |
| `done` | Completed and merged | Work finished, code in main branch |

**Status Progression:**
```
planned → in_progress → in_review → done
                ↓
             blocked (temporary)
```

---

## Updating Stories

### Daily Status Updates

**In standalone project:**
1. Read feature file: `specdeck/releases/R1-foundation/CLI-CORE.md`
2. Edit status in markdown table
3. Validate: `specdeck validate all`
4. User commits changes

**In coordinator's submodule:**
1. Navigate to submodule directory (e.g., `backend/`)
2. Read feature file: `specdeck/releases/R1-foundation/CLI-CORE.md`
3. Edit status in markdown table
4. Validate: `specdeck validate all`
5. User commits in submodule, updates coordinator, runs `specdeck sync`

### Creating New Stories

1. Identify target feature file
2. Check existing Story IDs to find next number
3. Add new row to Stories table
4. Use next sequential number (if last is 04, use 05)
5. Include all required columns: ID, Title, Status, Complexity
6. Validate: `specdeck validate all`
7. User commits changes

**Example:**
```markdown
| ID | Title | Status | Complexity | Estimate | Owner | Tags | Notes |
|----|-------|--------|------------|----------|-------|------|-------|
| CLI-CORE-04 | Config discovery | done | M | 5 | @user | cli, config | - |
| CLI-CORE-05 | New feature here | planned | S | 3 | @user | cli | New story |
```

---

## Overlay Mappings (Coordinator Mode)

**Purpose:** Link stories to Jira tickets in coordinator mode

**File:** `overlays/backend/CLI-CORE.md`

```markdown
---
feature: CLI-CORE
---

# Jira Mappings

| Story ID | Jira Ticket |
|----------|-------------|
| CLI-CORE-01 | PROJ-1001 |
| CLI-CORE-02 | PROJ-1002 |
```

**After creating/updating overlays:**
```bash
specdeck sync  # Apply mappings to cache
```

---

## Migrating Features to Submodules (Coordinator Mode)

**Scenario:** Feature currently exists in coordinator's `specdeck/` but should move to submodule. Jira mappings must stay in coordinator as overlay.

### Pre-Migration Checklist

1. **Verify coordinator mode:** Check `.specdeck.config.json` has `"coordinator": {"enabled": true}`
2. **Identify target submodule:** Determine which submodule will own the feature (e.g., `backend`)
3. **Check submodule exists:** Verify `submodule-repos/backend/` directory exists
4. **Verify submodule has SpecDeck:** Check `submodule-repos/backend/specdeck/` exists
5. **Identify release:** Note which release the feature belongs to (e.g., `R1-foundation`)

### Migration Steps

#### Step 1: Read Source Feature File (Coordinator)

**Location:** `specdeck/releases/R1-foundation/CLI-CORE.md`

**What to extract:**
- Complete feature content (YAML front matter + description + story table)
- Note if "Jira" column exists in story table
- Record all Jira ticket values for each story (e.g., CLI-CORE-01 → PROJ-1001)

#### Step 2: Create Feature File in Submodule

**Location:** `submodule-repos/backend/specdeck/releases/R1-foundation/CLI-CORE.md`

**Actions:**
1. Create directory if missing: `submodule-repos/backend/specdeck/releases/R1-foundation/`
2. Copy complete feature content from coordinator
3. **Remove Jira column** from story table (keep ID, Title, Status, Complexity, Estimate, Owner, Tags, Notes)
4. Preserve all other content (YAML, description, all stories)

**Example transformation:**

❌ **Before (in coordinator):**
```markdown
| ID | Title | Status | Complexity | Jira | Owner | Notes |
|----|-------|--------|------------|------|-------|-------|
| CLI-CORE-01 | Setup | done | M | PROJ-1001 | @user | Commander |
| CLI-CORE-02 | Logging | in_progress | S | PROJ-1002 | @user | Errors |
```

✅ **After (in submodule):**
```markdown
| ID | Title | Status | Complexity | Owner | Notes |
|----|-------|--------|------------|-------|-------|
| CLI-CORE-01 | Setup | done | M | @user | Commander |
| CLI-CORE-02 | Logging | in_progress | S | @user | Errors |
```

#### Step 3: Create Overlay File in Coordinator

**Location:** `overlays/backend/CLI-CORE.md`

**Actions:**
1. Create directory if missing: `overlays/backend/`
2. Create overlay file with Jira mappings extracted from Step 1
3. Include YAML front matter with `feature` field

**Overlay template:**
```markdown
---
feature: CLI-CORE
---

# Jira Mappings

| Story ID | Jira Ticket |
|----------|-------------|
| CLI-CORE-01 | PROJ-1001 |
| CLI-CORE-02 | PROJ-1002 |
```

**Rules:**
- Only include stories that have Jira tickets
- Story IDs must match exactly (including feature prefix)
- Omit stories without Jira tickets (empty cells)

#### Step 4: Update Release Overview in Submodule

**Location:** `submodule-repos/backend/specdeck/releases/R1-foundation.md`

**Actions:**
1. Check if release overview exists; create if missing
2. Add feature to "Features" section
3. Add feature to "Feature Files" section with story count

**Example addition:**
```markdown
## Features

- **CLI-CORE**: CLI Entry Point and Command Framework
  - Hierarchical command structure with Commander.js

## Feature Files

- [CLI-CORE](./R1-foundation/CLI-CORE.md) - 2 stories
```

#### Step 5: Remove Feature from Coordinator

**Location:** `specdeck/releases/R1-foundation/CLI-CORE.md`

**Actions:**
1. Delete the feature file completely
2. Update `specdeck/releases/R1-foundation.md` to remove feature from lists

**Important:** This is deletion, not modification. The feature no longer exists in coordinator.

#### Step 6: Validate Submodule

**Location:** `submodule-repos/backend/`

**Commands:**
```bash
cd submodule-repos/backend
specdeck validate all
```

**Expected:** No validation errors. If errors occur:
- Check YAML front matter (feature, release)
- Verify story table has required columns (ID, Title, Status, Complexity)
- Ensure Story IDs match feature name (CLI-CORE-01 in CLI-CORE.md)

#### Step 7: Sync Coordinator Cache

**Location:** Coordinator root

**Commands:**
```bash
cd ../..  # Back to coordinator root
specdeck sync
```

**What happens:**
- Reads stories from `submodule-repos/backend/specdeck/`
- Applies Jira mappings from `overlays/backend/CLI-CORE.md`
- Updates `.specdeck-cache/stories.json`

**Verification:**
```bash
specdeck list stories --feature CLI-CORE
```

Should show:
- Stories from submodule
- Jira tickets from overlay
- Repo indicator: `backend`

### Migration Verification Checklist

After migration, verify:

- [ ] Feature file exists in submodule: `submodule-repos/backend/specdeck/releases/R1-foundation/CLI-CORE.md`
- [ ] Feature file removed from coordinator: `specdeck/releases/R1-foundation/CLI-CORE.md` (deleted)
- [ ] Overlay exists: `overlays/backend/CLI-CORE.md`
- [ ] Overlay has all Jira mappings from original file
- [ ] Submodule feature file has NO Jira column
- [ ] Validation passes in submodule: `specdeck validate all`
- [ ] Sync completed in coordinator: `specdeck sync`
- [ ] Stories visible with Jira: `specdeck list stories --feature CLI-CORE` shows Jira tickets
- [ ] Release overview updated in submodule

### Handling Edge Cases

**If feature has no Jira tickets:**
- Skip Step 3 (no overlay needed)
- Remove Jira column if present (Step 2)
- Proceed with migration

**If feature spans multiple releases:**
- Migrate each release's feature file separately
- Create overlay for each release if Jira tickets exist
- Overlay path: `overlays/backend/CLI-CORE.md` (same for all releases if feature ID unchanged)

**If submodule doesn't exist yet:**
```bash
# User must run (agent cannot):
specdeck init submodule <repo-url> submodule-repos/backend
```

**If submodule not initialized with SpecDeck:**
```bash
# In submodule directory:
cd submodule-repos/backend
npx specdeck init copilot
cd ../..
```

**If overlay directory structure doesn't match submodule:**
- Overlay path MUST match submodule name: `overlays/backend/` for `submodule-repos/backend/`
- Check `.specdeck.config.json` for exact submodule names in `coordinator.submodules` array

### Common Migration Mistakes

❌ **Leaving Jira column in submodule:**
```markdown
# In submodule-repos/backend/specdeck/releases/R1-foundation/CLI-CORE.md
| ID | Title | Status | Jira |  ← WRONG! Remove this
```
**Problem:** Jira is coordinator-only concern.  
**Fix:** Remove Jira column entirely from submodule feature file.

❌ **Not creating overlay:**
```markdown
# Migration without overlay file
```
**Problem:** Jira mappings are lost after removing from submodule.  
**Fix:** Always create overlay if original feature had Jira column.

❌ **Wrong overlay path:**
```markdown
# overlays/CLI-CORE.md  ← WRONG! Missing submodule directory
```
**Problem:** Overlay not associated with submodule.  
**Fix:** Use `overlays/<submodule-name>/<feature>.md` structure.

❌ **Forgetting to sync:**
```bash
# After migration, not running: specdeck sync
```
**Problem:** Cache still has old data from coordinator.  
**Fix:** Always run `specdeck sync` after migration.

❌ **Not validating submodule:**
```bash
# Skipping: specdeck validate all in submodule
```
**Problem:** Errors only discovered when cache syncs.  
**Fix:** Always validate in submodule before syncing coordinator.

### Rollback Procedure

**If migration failed:**

1. **Restore feature in coordinator:**
   - Copy feature file back from submodule to coordinator
   - Re-add Jira column with original values
   - Update release overview

2. **Remove from submodule:**
   - Delete feature file from submodule
   - Update submodule release overview

3. **Remove overlay:**
   - Delete overlay file: `overlays/backend/CLI-CORE.md`

4. **Re-sync:**
   ```bash
   specdeck sync
   ```

5. **Validate coordinator:**
   ```bash
   specdeck validate all
   ```

---

## Validation Rules

**SpecDeck validates:**

1. **File Structure:**
   - Release overview exists: `specdeck/releases/R*.md`
   - Feature directory exists: `specdeck/releases/R*/`

2. **YAML Front Matter:**
   - Release: `id`, `title`, `timeframe`
   - Feature: `feature`, `release`

3. **Story Table:**
   - ⚠️ EXACTLY ONE table per feature file
   - Required columns present: ID, Title, Status, Complexity
   - Valid Status: `planned`, `in_progress`, `in_review`, `blocked`, `done`
   - Valid Complexity: `XS`, `S`, `M`, `L`, `XL`

4. **Story IDs:**
   - Match pattern: `FEATURE-NUMBER`
   - Match feature file: CLI-CORE-01 in CLI-CORE.md
   - Unique within feature

**Run validation:**
```bash
specdeck validate all
```

---

## Common Mistakes to Avoid

### ❌ Multiple Tables in Feature File
```markdown
## High Priority
| ID | Title | Status |
|----|-------|--------|
| CLI-CORE-01 | Setup | done |

## Low Priority
| ID | Title | Status |
|----|-------|--------|
| CLI-CORE-02 | Docs | planned |
```
**Problem:** Parser only reads first table, CLI-CORE-02 is lost!  
**Fix:** Merge into single table, use Tags or Priority column if needed.

### ❌ Wrong Story ID in Feature File
```markdown
File: specdeck/releases/R1-foundation/CLI-CORE.md

| ID | Title | Status |
|----|-------|--------|
| REL-01-01 | Setup | done |  ← WRONG! Doesn't match CLI-CORE
```
**Problem:** Story won't be found when listing CLI-CORE feature.  
**Fix:** Use CLI-CORE-01 or move to REL-01.md file.

### ❌ Invalid Status/Complexity Values
```markdown
| ID | Title | Status | Complexity |
|----|-------|--------|------------|
| CLI-CORE-01 | Setup | completed | medium |
```
**Problem:** Parser expects exact enum values.  
**Fix:** Use `done` (not completed) and `M` (not medium).

### ❌ Missing Required Columns
```markdown
| ID | Title |
|----|-------|
| CLI-CORE-01 | Setup |
```
**Problem:** Missing Status and Complexity.  
**Fix:** Add all required columns.

---

## Tips for AI Agents

### General Rules
1. ✅ **Read before write:** Always read feature file before editing
2. ✅ **Check IDs:** Verify next sequential number to avoid duplicates
3. ✅ **Single table:** Never split stories into multiple tables
4. ✅ **Validate:** Run `specdeck validate all` after changes
5. ✅ **Match IDs to files:** CLI-CORE-01 belongs in CLI-CORE.md
6. ❌ **Never commit:** Leave git operations to user

### Coordinator Mode
1. ✅ **Check mode:** Read `.specdeck.config.json` for `coordinator.enabled`
2. ✅ **Know location:** Determine if in coordinator or submodule directory
3. ✅ **Read from cache:** In coordinator, use `specdeck list stories` (uses cache)
4. ✅ **Edit in submodule:** Story updates happen in submodule's `specdeck/` directory
5. ✅ **User syncs:** User runs `specdeck sync` after submodule updates (don't automate)
6. ❌ **Don't edit cache:** Never modify `.specdeck-cache/stories.json` directly

### Story Management
1. ✅ **Sequential numbers:** If last story is CLI-CORE-04, next is CLI-CORE-05
2. ✅ **Consistent columns:** Keep same column order across all features
3. ✅ **Valid enums:** Status: planned/in_progress/in_review/blocked/done, Complexity: XS/S/M/L/XL
4. ✅ **Preserve structure:** Don't remove optional columns if already present
5. ❌ **No table splits:** Don't organize stories into multiple tables by sprint/priority

---

## Troubleshooting

**Stories not showing up?**
- Check you're editing correct feature file
- Verify Story ID matches feature (CLI-CORE-01 in CLI-CORE.md)
- Run `specdeck validate all` to see errors
- Ensure YAML front matter exists

**Parser not finding table?**
- Verify only ONE table in file
- Ensure table has header separator row with `|---|---|`
- Check required columns: ID, Title, Status, Complexity

**Coordinator cache is stale?**
- User must run `specdeck sync` to refresh
- Check `.specdeck-cache/stories.json` exists
- Verify submodules listed in `.specdeck.config.json`

**Validation errors?**
- Status values: `planned`, `in_progress`, `in_review`, `blocked`, `done`
- Complexity values: `XS`, `S`, `M`, `L`, `XL`
- Story ID format: `FEATURE-NUMBER` (e.g., CLI-CORE-01)
- YAML front matter: `feature` and `release` required

<!-- SPECDECK:END -->

